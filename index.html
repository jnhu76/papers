<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学术论文库</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .last-update {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .papers-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .paper-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .paper-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .paper-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .paper-authors {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .paper-year {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .paper-link {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
        }
        .paper-link:hover {
            background: #0056b3;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>学术论文库</h1>
        <div id="lastUpdate" class="last-update">正在加载更新时间...</div>
        <div class="stats">
            <div id="totalPapers" class="stat-item">总计: 加载中...</div>
            <div id="dataSource" class="stat-item">数据源: 加载中...</div>
        </div>
    </div>

    <div id="papersContainer" class="papers-container">
        <div class="loading">正在加载论文数据...</div>
    </div>

    <script>
        class PaperManager {
            constructor() {
                this.dbName = 'PapersDB';
                this.storeName = 'papers';
                this.cacheDuration = 24 * 60 * 60 * 1000; // 24小时缓存
            }

            // 初始化数据库
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onerror = () => reject(request.error);
                });
            }

            // 从IndexedDB获取数据
            async getFromDB(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            // 保存数据到IndexedDB
            async saveToDB(key, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(data, key);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // 检查数据是否需要更新
            async shouldUpdateData() {
                try {
                    const cachedData = await this.getFromDB('papers_data');
                    if (!cachedData) return true;

                    const currentTime = Date.now();
                    const timeDiff = currentTime - cachedData.time;
                    
                    return timeDiff > this.cacheDuration;
                } catch (error) {
                    console.error('检查数据更新时出错:', error);
                    return true;
                }
            }

            // 从服务器获取数据
            async fetchFromServer() {
                try {
                    const response = await fetch('./papers_data.json');
                    if (!response.ok) throw new Error('网络响应不正常');
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('从服务器获取数据失败:', error);
                    throw error;
                }
            }

            // 获取论文数据（优先从缓存读取）
            async getPapersData() {
                await this.initDB();
                
                const shouldUpdate = await this.shouldUpdateData();
                let dataSource = '缓存';

                if (shouldUpdate) {
                    try {
                        const serverData = await this.fetchFromServer();
                        await this.saveToDB('papers_data', serverData);
                        dataSource = '服务器（已更新）';
                        return { data: serverData, source: dataSource };
                    } catch (error) {
                        console.warn('使用缓存数据，因为服务器获取失败');
                    }
                }

                const cachedData = await this.getFromDB('papers_data');
                if (!cachedData) {
                    throw new Error('没有可用的数据');
                }

                return { data: cachedData, source: dataSource };
            }

            // 渲染论文列表
            renderPapers(papers, timestamp, dataSource) {
                const container = document.getElementById('papersContainer');
                const lastUpdate = document.getElementById('lastUpdate');
                const totalPapers = document.getElementById('totalPapers');
                const dataSourceElement = document.getElementById('dataSource');

                // 更新头部信息
                lastUpdate.textContent = `最后更新: ${new Date(timestamp).toLocaleString()}`;
                totalPapers.textContent = `总计: ${papers.length} 篇论文`;
                dataSourceElement.textContent = `数据源: ${dataSource}`;

                if (papers.length === 0) {
                    container.innerHTML = '<div class="error">没有找到论文数据</div>';
                    return;
                }

                // 渲染论文卡片
                container.innerHTML = papers.map(paper => `
                    <div class="paper-card">
                        <div class="paper-title">${paper.title || '未知标题'}</div>
                        <div class="paper-authors">${paper.authors || '未知作者'}</div>
                        <div class="paper-year">年份: ${paper.year || '未知'}</div>
                        ${paper.abstract ? `<div style="font-size: 14px; color: #666; margin-bottom: 10px; line-height: 1.4;">${paper.abstract}</div>` : ''}
                        ${paper.htmlFile ? `<a href="${paper.htmlFile}" class="paper-link" target="_blank">查看详情</a>` : ''}
                    </div>
                `).join('');
            }

            // 显示错误信息
            showError(message) {
                const container = document.getElementById('papersContainer');
                container.innerHTML = `<div class="error">${message}</div>`;
            }

            // 初始化
            async init() {
                try {
                    const result = await this.getPapersData();
                    this.renderPapers(result.data.papers, result.data.time, result.source);
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.showError(`加载数据失败: ${error.message}`);
                }
            }
        }

        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker 注册成功:', registration);
                })
                .catch(error => {
                    console.log('Service Worker 注册失败:', error);
                });
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            const paperManager = new PaperManager();
            paperManager.init();
        });
    </script>
</body>
</html>